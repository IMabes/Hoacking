<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kullanƒ±cƒ± Profili - Hoacking</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/page.css">
    <link rel="stylesheet" href="css/profile.css">
</head>
<body class="profile-body">
    <script src="js/includes.js"></script>
    <script src="js/activity-tracker.js"></script>
    <div id="navbar"></div>
    <div id="blob"></div>
    
    <div class="profile-container">
        <!-- User Header Section -->
        <div class="profile-header">
            <div class="profile-avatar-container">
                <div class="profile-avatar">
                    <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="60" cy="60" r="60" fill="url(#avatarGradient)"/>
                        <circle cx="60" cy="45" r="20" fill="#00ff88"/>
                        <ellipse cx="60" cy="95" rx="25" ry="20" fill="#00ff88"/>
                        <defs>
                            <linearGradient id="avatarGradient" x1="0" y1="0" x2="120" y2="120">
                                <stop offset="0%" stop-color="#ff0099" stop-opacity="0.3"/>
                                <stop offset="100%" stop-color="#00ff88" stop-opacity="0.3"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="avatar-glow"></div>
            </div>
            <div class="profile-info">
                <h1 class="profile-username" id="profileUsername">Hacker_User</h1>
                <p class="profile-bio" id="profileBio" contenteditable="false">Siber g√ºvenlik tutkunu | Penetrasyon Test Uzmanƒ± | Bug Hunter</p>
                <button class="edit-profile-btn" id="editProfileBtn">Profili D√ºzenle</button>
            </div>
        </div>

        <!-- Genel ƒ∞lerleme Paneli B√∂l√ºm√º -->
        <div class="progress-panel">
            <h2 class="section-title">Genel ƒ∞lerleme</h2>
            <div class="progress-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalProgress">0%</div>
                    <div class="stat-label">Toplam Tamamlanma</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="totalProgressBar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="coursesCompleted">0</div>
                    <div class="stat-label">Tamamlanan Kurslar</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="coursesInProgress">0</div>
                    <div class="stat-label">Devam Eden Kurslar</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalHours">0</div>
                    <div class="stat-label">√ñƒürenilen Saat</div>
                </div>
            </div>
        </div>

        <!-- Tamamlanan Kurslar B√∂l√ºm√º -->
        <div class="courses-section">
            <h2 class="section-title">Tamamlanan Kurslar</h2>
            <div class="courses-grid" id="completedCoursesGrid">
                <!-- Completed course cards will be dynamically generated -->
            </div>
        </div>

        <!-- Devam Eden Kurslar B√∂l√ºm√º -->
        <div class="courses-section">
            <h2 class="section-title">Devam Eden Kurslar</h2>
            <div class="courses-grid" id="inProgressCoursesGrid">
                <!-- In-progress course cards will be dynamically generated -->
            </div>
        </div>

        <!-- √ñd√ºller B√∂l√ºm√º -->
        <div class="badges-section">
            <h2 class="section-title">Kazanƒ±lan Rozetler</h2>
            <div class="badges-grid" id="badgesGrid">
                <!-- Rozetler dinamik olarak olu≈üturulacak -->
            </div>
        </div>

        <!-- Son Aktivite Zaman √áizelgesi B√∂l√ºm√º -->
        <div class="activity-section">
            <h2 class="section-title">Son Aktiviteler</h2>
            <div class="activity-timeline" id="activityTimeline">
                <!-- Aktivite √∂ƒüeleri dinamik olarak olu≈üturulacak -->
            </div>
        </div>

        <!-- G√ºvenlik Ayarlarƒ± B√∂l√ºm√º -->
        <div class="security-section">
            <h2 class="section-title">G√ºvenlik Ayarlarƒ±</h2>
            <div class="security-options">
                <div class="security-item">
                    <div class="security-info">
                        <h3>ƒ∞ki Fakt√∂rl√º Kimlik Doƒürulama</h3>
                        <p>Hesabƒ±nƒ±za ekstra bir g√ºvenlik katmanƒ± ekleyin</p>
                    </div>
                    <button class="security-btn">2FA'yƒ± Etkinle≈ütir</button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <h3>≈ûifre Deƒüi≈ütir</h3>
                        <p>Hesap ≈üifrenizi g√ºncelleyin</p>
                    </div>
                    <button class="security-btn">≈ûifre Deƒüi≈ütir</button>
                </div>
                <div class="security-item">
                    <div class="security-info">
                        <h3>Hesap Ayarlarƒ±</h3>
                        <p>Hesap tercihlerinizi y√∂netin</p>
                    </div>
                    <button class="security-btn">Ayarlar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>

    <script>

        // Load user data from localStorage or API -> localStorage'dan veya API'den kullanƒ±cƒ± verilerini y√ºkle
        async function loadUserData() {
            // Try to get user data from localStorage (set during login) -> localStorage'dan kullanƒ±cƒ± verilerini y√ºkle
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            if (userData.nickname) {
                document.getElementById('profileUsername').textContent = userData.nickname;
            }
            
            // API'den veri √ßekmek i√ßin kullanƒ±cƒ± ID'si varsa
            if (userData.id) {
                try {
                    // Load user profile data
                    const userResponse = await fetch(`http://localhost:3000/api/user/${userData.id}`);
                    const userData_result = await userResponse.json();
                    
                    if (userData_result.success && userData_result.user) {
                        updateProfile(userData_result.user);
                    }
                    
                    // Load user progress data
                    const progressResponse = await fetch(`http://localhost:3000/api/user/${userData.id}/progress`);
                    const progressData = await progressResponse.json();
                    
                    console.log('Progress data:', progressData);
                    console.log('Progress data courses:', progressData.courses);
                    
                    if (progressData.success) {
                        updateProgress(progressData.progress);
                        console.log('Courses data:', progressData.courses);
                        console.log('Courses count:', progressData.courses ? progressData.courses.length : 0);
                        
                        if (progressData.courses && progressData.courses.length > 0) {
                            progressData.courses.forEach((course, idx) => {
                                console.log(`Course ${idx + 1}:`, {
                                    id: course.id,
                                    title: course.title,
                                    status: course.status,
                                    progress: course.progress
                                });
                            });
                        }
                        
                        renderCoursesFromData(progressData.courses || []);
                    } else {
                        console.error('Progress data error:', progressData.message);
                    }
                    
                    // Load user badges
                    const badgesResponse = await fetch(`http://localhost:3000/api/user/${userData.id}/badges`);
                    const badgesData = await badgesResponse.json();
                    
                    if (badgesData.success) {
                        renderBadgesFromData(badgesData.badges);
                    }
                    
                    // Load user activity
                    const activityResponse = await fetch(`http://localhost:3000/api/user/${userData.id}/activity?limit=10`);
                    const activityData = await activityResponse.json();
                    
                    if (activityData.success) {
                        renderActivityFromData(activityData.activities);
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // localStorage verilerine geri d√∂n√º≈ü
                    if (userData.nickname) {
                        document.getElementById('profileUsername').textContent = userData.nickname;
                    }
                }
            }
        }
        
        // Update progress statistics
        function updateProgress(progress) {
            document.getElementById('totalProgress').textContent = progress.totalProgress + '%';
            document.getElementById('totalProgressBar').querySelector('.progress-fill').style.width = progress.totalProgress + '%';
            document.getElementById('coursesCompleted').textContent = progress.coursesCompleted;
            document.getElementById('coursesInProgress').textContent = progress.coursesInProgress;
            document.getElementById('totalHours').textContent = progress.totalHours;
        }
        
        // Render courses from API data - separated by status
        function renderCoursesFromData(courses) {
            const completedGrid = document.getElementById('completedCoursesGrid');
            const inProgressGrid = document.getElementById('inProgressCoursesGrid');
            
            console.log('Rendering courses:', courses);
            
            if (!courses || courses.length === 0) {
                completedGrid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px; grid-column: 1 / -1;">Hen√ºz kurs ba≈ülatƒ±lmamƒ±≈ü.</p>';
                inProgressGrid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px; grid-column: 1 / -1;">Hen√ºz kurs ba≈ülatƒ±lmamƒ±≈ü.</p>';
                return;
            }
            
            // Separate courses by status - Veritabanƒ±ndan gelen status'a g√∂re ayƒ±r
            // Tamamlanan kurslar: status = 'completed' veya t√ºm quiz'ler tamamlanmƒ±≈ü
            const completedCourses = courses.filter(course => {
                return course.status === 'completed' || 
                       (course.total_quizzes > 0 && course.completed_quizzes === course.total_quizzes);
            });
            // Devam eden kurslar: status = 'in_progress' veya 'enrolled' ve en az bir quiz tamamlanmƒ±≈ü ama hepsi deƒüil
            const inProgressCourses = courses.filter(course => {
                return (course.status === 'in_progress' || course.status === 'enrolled') &&
                       !(course.total_quizzes > 0 && course.completed_quizzes === course.total_quizzes);
            });
            
            // Map course categories/icons
            const categoryIcons = {
                'Penetrasyon Testi Eƒüitimi': 'üéØ',
                'Penetrasyon Testi': 'üéØ',
                'Linux Temelleri': 'üêß',
                'Siber G√ºvenlik Temelleri': 'üîí',
                'Siber G√ºvenlik': 'üîí',
                'Exploit Attack': 'üí•',
                'Network Security': 'üåê',
                'Web Security': 'üï∑Ô∏è',
                'Cryptography': 'üîê'
            };
            
            // Helper function to render course card
            function renderCourseCard(course) {
                // Find matching icon
                let icon = 'üìö';
                for (const [key, value] of Object.entries(categoryIcons)) {
                    if (course.title.includes(key) || key.includes(course.title)) {
                        icon = value;
                        break;
                    }
                }
                
                const category = course.title.includes('Penetrasyon') ? 'Penetrasyon Testi' :
                               course.title.includes('Linux') ? 'Linux Temelleri' :
                               course.title.includes('Siber') ? 'Siber G√ºvenlik' :
                               course.title.includes('Exploit') ? 'Exploit Saldƒ±rƒ±larƒ±' :
                               course.title.includes('Network') ? 'Aƒü G√ºvenliƒüi' :
                               'Kurs';
                
                const isCompleted = course.status === 'completed';
                const buttonText = isCompleted ? 'Tekrar G√∂r√ºnt√ºle' : 'Devam Et';
                const buttonClass = isCompleted ? 'continue-btn completed' : 'continue-btn';
                
                return `
                    <div class="course-card ${isCompleted ? 'completed' : ''}">
                        <div class="course-thumbnail">${icon}</div>
                        <div class="course-content">
                            <div class="course-category">${category}</div>
                            <h3 class="course-title">${course.title}</h3>
                            <div class="course-progress">
                                <div class="progress-info">
                                    <span>ƒ∞lerleme</span>
                                    <span>${course.progress}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${course.progress}%"></div>
                                    </div>
                                </div>
                            </div>
                            ${isCompleted ? '<div class="course-badge completed-badge">‚úì Tamamlandƒ±</div>' : ''}
                            <button class="${buttonClass}" onclick="continueCourse(${course.id})">${buttonText}</button>
                        </div>
                    </div>
                `;
            }
            
            // Render completed courses
            if (completedCourses.length === 0) {
                completedGrid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px; grid-column: 1 / -1;">Hen√ºz tamamlanan kurs yok.</p>';
            } else {
                completedGrid.innerHTML = completedCourses.map(renderCourseCard).join('');
            }
            
            // Render in-progress courses
            if (inProgressCourses.length === 0) {
                inProgressGrid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px; grid-column: 1 / -1;">Hen√ºz devam eden kurs yok.</p>';
            } else {
                inProgressGrid.innerHTML = inProgressCourses.map(renderCourseCard).join('');
            }
        }
        
        // Continue course function
        function continueCourse(courseId) {
            window.location.href = `course-detail.html?id=${courseId}`;
        }

        // Profili g√ºncelleme
        function updateProfile(user) {
            if (user.nickname) {
                document.getElementById('profileUsername').textContent = user.nickname;
            }
            if (user.bio) {
                document.getElementById('profileBio').textContent = user.bio;
            }
        }


        //√ñd√ºlleri(bagde) g√∂r√ºnt√ºleme - Veritabanƒ±ndan
        function renderBadgesFromData(badges) {
            const grid = document.getElementById('badgesGrid');
            
            if (!badges || badges.length === 0) {
                grid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px;">Hen√ºz rozet kazanƒ±lmadƒ±.</p>';
                return;
            }
            
            grid.innerHTML = badges.map(badge => `
                <div class="badge-card">
                    <div class="badge-icon">${badge.icon}</div>
                    <h4 class="badge-name">${badge.name}</h4>
                    <p class="badge-description">${badge.description}</p>
                </div>
            `).join('');
        }

        // Aktivite zaman √ßizelgesini g√∂r√ºnt√ºleme - Veritabanƒ±ndan
        function renderActivityFromData(activities) {
            const timeline = document.getElementById('activityTimeline');
            
            if (!activities || activities.length === 0) {
                timeline.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px;">Hen√ºz aktivite bulunmuyor.</p>';
                return;
            }
            
            timeline.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-dot"></div>
                    <div class="activity-content">
                        <p><span class="activity-action">${activity.action}</span> <span class="activity-course">${activity.course}</span></p>
                        <span class="activity-time">${activity.time}</span>
                    </div>
                </div>
            `).join('');
        }

        // profil d√ºzenleme i≈ülemi
        document.getElementById('editProfileBtn').addEventListener('click', async function() {
            const bio = document.getElementById('profileBio');
            const isEditable = bio.contentEditable === 'true';
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            if (isEditable) {
                // bio'yƒ± kaydet
                bio.contentEditable = 'false';
                this.textContent = 'Profili D√ºzenle';
                this.disabled = true;
                
                // bio'yƒ± backend'e kaydet
                if (userData.id) {
                    try {
                        const response = await fetch(`http://localhost:3000/api/user/${userData.id}/bio`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ bio: bio.textContent })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            console.log('Bio ba≈üarƒ±yla kaydedildi');
                        }
                    } catch (error) {
                        console.error('Bio kaydetme hatasƒ±:', error);
                    }
                }
                
                this.disabled = false;
            } else {
                bio.contentEditable = 'true';
                bio.focus();
                this.textContent = 'Kaydet';
            }
        });

        function continueCourse(courseId) {
            // Kurs detay sayfasƒ±na y√∂nlendir
            window.location.href = `course-detail.html?id=${courseId}`;
        }

        // Navbar'ƒ± g√ºncelle ve profil linkini g√∂ster
        function updateNavbar() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            if (userData.id) {
                // Giri≈ü/Kayƒ±t d√ºƒümelerini g√ºncelle ve profil linkini g√∂ster
                const loginRegisterDiv = document.querySelector('.login-register');
                if (loginRegisterDiv) {
                    loginRegisterDiv.innerHTML = `
                        <button onclick="window.location.href='profile.html'">PROFƒ∞L</button>
                        <button onclick="logout()">√áIKI≈û</button>
                    `;
                }
            }
        }

        // √áƒ±kƒ±≈ü i≈ülemini ger√ßekle≈ütir
        function logout() {
            localStorage.removeItem('userData');
            // profile.html public klas√∂r√ºnde, index.html root'ta
            window.location.href = '../index.html';
        }

        // √áƒ±kƒ±≈ü i≈ülemini global olarak kullanƒ±labilir hale getir
        window.logout = logout;

        // Sayfayƒ± ba≈ülat
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData(); // This will now load progress, courses, badges, and activity from API
            
            // Navbar'ƒ±n y√ºklenmesini bekle, ardƒ±ndan g√ºncelle
            setTimeout(updateNavbar, 500);
        });
    </script>
</body>
</html>

